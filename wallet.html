<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ë‚´ ì§€ê°‘ - LUCKYBOX</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:640px; margin:32px auto; padding:0 16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.05); }
    input, button { padding:12px; border-radius:8px; border:1px solid #ddd; }
    button { background:#111; color:#fff; border:none; cursor:pointer; }
    button:hover { opacity:.92; }
    #msg { margin-top:10px; min-height:20px; }
  </style>
</head>
<body>
  <h2>ë‚´ ì§€ê°‘</h2>
  <div class="card">
    <p><b>ì”ì•¡:</b> <span id="balance">-</span> P</p>
    <label>ì¶©ì „ ê¸ˆì•¡ (ì› = í¬ì¸íŠ¸)</label>
    <input id="amt" type="number" min="1000" step="1000" value="1000"/>
    <button id="topupBtn">ì¶©ì „(ì„ì‹œ)</button>
    <p id="msg"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // ğŸ”§ login.htmlê³¼ ë™ì¼í•œ Firebase ì„¤ì •ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzr0NdCE6bMyz8J3Z4nKocZPECabcuZQzUEMjt9lbudyHmpebfGrK9ut1Xus_WUvewd/exec";
    const msg = (t)=> document.getElementById('msg').innerText = t;

    let currentUser = null;

    async function refreshBalance() {
      if (!currentUser) return;
      const q = new URLSearchParams({ action:'customer', uid: currentUser.uid });
      const res = await fetch(`${WEBAPP_URL}?${q}`);
      const json = await res.json();
      document.getElementById('balance').innerText = json.points ?? 0;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ëƒ„ (ëŒì•„ì˜¬ ì£¼ì†Œ í¬í•¨)
        location.href = `login.html?redirect=${encodeURIComponent(location.href)}`;
      } else {
        currentUser = user;
        await refreshBalance();
      }
    });

    document.getElementById('topupBtn').addEventListener('click', async () => {
      if (!currentUser) return;
      const amount = Number(document.getElementById('amt').value || 0);
      if (!(amount > 0)) { msg('ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.'); return; }
      msg('ì¶©ì „ ì²˜ë¦¬ ì¤‘â€¦(ì„ì‹œ)');

      // âš ï¸ Day2ì—ì„œ ì‹¤ì œ ê²°ì œ ì„±ê³µ ì½œë°± ë’¤ì— ì´ ìš”ì²­ì„ í˜¸ì¶œí•˜ë„ë¡ ë°”ê¿€ ì˜ˆì •
      const res = await fetch(WEBAPP_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ type:'topup', uid: currentUser.uid, email: currentUser.email || '', amount, note:'TEST_TOPUP' })
      });
      const json = await res.json();
      if (json.result === 'success') {
        msg('âœ… ì¶©ì „ ì™„ë£Œ');
        await refreshBalance();
      } else {
        msg('âš ï¸ ì¶©ì „ ì‹¤íŒ¨: ' + (json.message || 'unknown'));
      }
    });
  </script>
</body>
</html>
