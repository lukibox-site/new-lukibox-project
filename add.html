<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>상품 목록 - LUCKYBOX</title>
  <style>
    :root { --card-w: 260px; --accent:#e67e22; --accent-dark:#d35400; }
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      color: #333;
      padding: 50px 20px;
    }
    .top-links {
      position: fixed; right: 16px; top: 16px;
      background: #fff; padding: 6px 10px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      z-index: 10;
    }
    h1 { text-align: center; margin: 0 0 24px; }
    .product-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 24px; }
    .product {
      background-color: #fff;
      width: var(--card-w);
      text-align: center;
      border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,.08);
      padding: 18px; display:flex; flex-direction:column; gap:10px;
    }
    .product img {
      width: 100%; height: auto; border-radius: 8px;
      aspect-ratio: 4 / 3; object-fit: cover; display: block; cursor: zoom-in;
    }
    .cta-button {
      background-color: var(--accent); color: #fff; padding: 10px 20px;
      font-size: 16px; border: none; border-radius: 6px; cursor: pointer;
    }
    .cta-button:hover { background-color: var(--accent-dark); }
    .desc { color:#444; font-size:14px; line-height:1.4; min-height:3em; }

    /* ===== 모달 갤러리 ===== */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      display: none; align-items: center; justify-content: center; z-index: 999;
      padding: 20px;
    }
    .modal.open { display: flex; }
    .viewer {
      background:#111; color:#fff; border-radius:12px; width: min(900px, 96vw);
      padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    .viewer-main {
      position: relative; background:#000; border-radius:10px; overflow:hidden;
      aspect-ratio: 16/10; display:flex; align-items:center; justify-content:center;
    }
    .viewer-main img { max-width:100%; max-height:100%; display:block; }
    .nav {
      position:absolute; top:50%; transform:translateY(-50%); width:100%;
      display:flex; justify-content:space-between; pointer-events:none;
    }
    .nav button {
      pointer-events:auto; background:rgba(0,0,0,.45); color:#fff; border:none;
      font-size:22px; width:44px; height:44px; border-radius:50%; cursor:pointer;
    }
    .thumbs {
      display:flex; gap:8px; padding:10px 4px; overflow-x:auto; margin-top:6px;
    }
    .thumbs img {
      width:90px; height:68px; object-fit:cover; border-radius:6px; cursor:pointer;
      opacity:.7; border:2px solid transparent;
    }
    .thumbs img.active { opacity:1; border-color:#fff; }
    .viewer-top { display:flex; justify-content:space-between; align-items:center; padding:4px 6px 10px; }
    .viewer-title { font-weight:700; font-size:16px; color:#eee; }
    .close { background:transparent; color:#fff; border:none; font-size:22px; cursor:pointer; }
  </style>
</head>
<body>

<div class="top-links">
  <a href="login.html">로그인</a> |
  <a href="wallet.html">지갑</a>
</div>

<h1>등록된 상품 목록</h1>
<div class="product-list" id="productList"></div>

<!-- 갤러리 모달 -->
<div class="modal" id="galleryModal" aria-hidden="true">
  <div class="viewer" role="dialog" aria-modal="true">
    <div class="viewer-top">
      <div class="viewer-title" id="viewerTitle"></div>
      <button class="close" id="closeModal" aria-label="닫기">✕</button>
    </div>
    <div class="viewer-main">
      <img id="viewerImage" alt="상품 이미지" />
      <div class="nav">
        <button id="prevBtn" aria-label="이전">‹</button>
        <button id="nextBtn" aria-label="다음">›</button>
      </div>
    </div>
    <div class="thumbs" id="thumbs"></div>
  </div>
</div>

<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzr0NdCE6bMyz8J3Z4nKocZPECabcuZQzUEMjt9lbudyHmpebfGrK9ut1Xus_WUvewd/exec';
  const PLACEHOLDER = 'https://via.placeholder.com/600x400?text=LUCKYBOX';

  const toDisplayDate = (d) => {
    try { const dt = new Date(d); if (!isNaN(dt)) return dt.toLocaleString('ko-KR'); }
    catch {}
    return String(d || '');
  };

  // ===== 목록 로딩 =====
  async function loadProducts() {
    const url = `${WEBAPP_URL}?_=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });
    const products = await res.json();

    products.sort((a,b) => new Date(b.registeredDate || 0) - new Date(a.registeredDate || 0));

    const list = document.getElementById('productList');
    list.innerHTML = '';

    products.forEach(p => {
      // 이미지들 추출(최대 4개)
      const imgs = String(p.productImage || '').trim().split(/\s+/).filter(Boolean).slice(0,4);
      const first = imgs[0] || PLACEHOLDER;

      const card = document.createElement('div');
      card.className = 'product';
      card.innerHTML = `
        <img src="${first}" alt="${p.productName}" loading="lazy" decoding="async" />
        <h3 style="margin:6px 0 0">${p.productName}</h3>
        <div class="desc">${(p.productDescription || '').replace(/\n/g,'<br>')}</div>
        <p style="margin:0 0 8px;">마감일: ${toDisplayDate(p.productDeadline)}</p>
        <button class="cta-button">응모하기</button>
      `;

      // 이미지 에러 시 대체
      const imgEl = card.querySelector('img');
      imgEl.onerror = () => { imgEl.src = PLACEHOLDER; };

      // 이미지 클릭 → 갤러리 모달
      imgEl.addEventListener('click', () => openGallery(p.productName, imgs));

      // 응모하기 → pay.html
      card.querySelector('.cta-button').addEventListener('click', () => {
        location.href = `pay.html?product=${encodeURIComponent(p.productName)}`;
      });

      list.appendChild(card);
    });
  }

  // ===== 갤러리 모달 동작 =====
  const modal = document.getElementById('galleryModal');
  const viewerImg = document.getElementById('viewerImage');
  const viewerTitle = document.getElementById('viewerTitle');
  const thumbs = document.getElementById('thumbs');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const closeBtn = document.getElementById('closeModal');

  let gallery = { title:'', images:[], index:0 };

  function openGallery(title, images) {
    gallery.title = title;
    gallery.images = images.length ? images : [PLACEHOLDER];
    gallery.index = 0;

    viewerTitle.textContent = title;
    renderGallery();
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  function closeGallery() {
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  function renderGallery() {
    const url = gallery.images[gallery.index] || PLACEHOLDER;
    viewerImg.src = url;
    viewerImg.onerror = () => { viewerImg.src = PLACEHOLDER; };

    // 썸네일
    thumbs.innerHTML = '';
    gallery.images.forEach((u, i) => {
      const t = document.createElement('img');
      t.src = u; t.alt = `thumb-${i}`;
      t.onerror = () => { t.src = PLACEHOLDER; };
      if (i === gallery.index) t.classList.add('active');
      t.addEventListener('click', () => { gallery.index = i; renderGallery(); });
      thumbs.appendChild(t);
    });
  }

  prevBtn.addEventListener('click', () => {
    gallery.index = (gallery.index - 1 + gallery.images.length) % gallery.images.length;
    renderGallery();
  });
  nextBtn.addEventListener('click', () => {
    gallery.index = (gallery.index + 1) % gallery.images.length;
    renderGallery();
  });
  closeBtn.addEventListener('click', closeGallery);
  modal.addEventListener('click', (e) => { if (e.target === modal) closeGallery(); });
  window.addEventListener('keydown', (e) => {
    if (!modal.classList.contains('open')) return;
    if (e.key === 'Escape') closeGallery();
    if (e.key === 'ArrowLeft') prevBtn.click();
    if (e.key === 'ArrowRight') nextBtn.click();
  });

  // 첫 로드 + 5초 후 재로딩 (시트 반영 지연 대비)
  loadProducts();
  setTimeout(() => { loadProducts().catch(()=>{}); }, 5000);
</script>

</body>
</html>
