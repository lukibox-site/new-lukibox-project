<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>상품 목록 - LUCKYBOX</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f0f0; color:#333; padding:50px; }
    .top-links { position:fixed; right:16px; top:16px; background:#fff; padding:6px 10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.08); z-index:10; }
    h1 { text-align:center; }
    .product-list { display:flex; flex-wrap:wrap; justify-content:center; }
    .product { background:#fff; margin:15px; padding:20px; width:260px; text-align:center; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,.1); }
    .product img { width:100%; height:auto; border-radius:5px; aspect-ratio:4/3; object-fit:cover; display:block; }
    .cta-button { background:#e67e22; color:#fff; padding:10px 20px; font-size:16px; border:none; border-radius:5px; cursor:pointer; }
    .cta-button:hover { background:#d35400; }
  </style>
</head>
<body>

<div class="top-links">
  <a href="login.html">로그인</a> |
  <a href="wallet.html">지갑</a>
</div>

<h1>등록된 상품 목록</h1>
<div class="product-list" id="productList"></div>

<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyF_qi36KOrFRH1Qht2KFKFhVMJJUjjDYfbBognL8nUQF60l5OHrJlJTlCIENXawRA/exec';
  const PLACEHOLDER = 'https://via.placeholder.com/600x400?text=LUCKYBOX';

  const toDisplayDate = (d) => {
    try { const dt = new Date(d); if (!isNaN(dt)) return dt.toLocaleString('ko-KR'); return String(d||''); }
    catch { return String(d||''); }
  };

  async function fetchJSON(url){
    const u = new URL(url); u.searchParams.set('_', Date.now());
    const res = await fetch(u, {cache:'no-store', redirect:'follow'});
    const text = await res.text();
    return JSON.parse(text);
  }

  async function loadProducts(){
    const list = document.getElementById('productList');
    list.innerHTML = '<p style="color:#666">불러오는 중…</p>';
    try{
      const products = await fetchJSON(WEBAPP_URL + '?action=products');
      products.sort((a,b)=>new Date(b.registeredDate||0)-new Date(a.registeredDate||0));
      if(!products.length){ list.innerHTML = '<p style="color:#666">등록된 상품이 없습니다.</p>'; return; }
      list.innerHTML = '';
      products.forEach(p=>{
        let img = (p.productImage||'').trim(); if(img.includes(' ')) img = img.split(/\s+/)[0];
        const card = document.createElement('div');
        card.className='product';
        card.innerHTML = `
          <img src="${img||PLACEHOLDER}" alt="${p.productName||''}" loading="lazy" />
          <h3>${p.productName||''}</h3>
          <p>${(p.productDescription||'').replace(/\n/g,'<br>')}</p>
          <p>마감일: ${toDisplayDate(p.productDeadline)}</p>
          <button class="cta-button">응모하기</button>
        `;
        card.querySelector('.cta-button').addEventListener('click', ()=>{
          const name = p.productName ? encodeURIComponent(p.productName) : '';
          const baseUrl = new URL('.', window.location.href);
          const target  = new URL('participation.html', baseUrl);
          target.searchParams.set('product', name);
          target.searchParams.set('v', Date.now()); // 캐시 무력화
          location.href = target.toString();
        });
        list.appendChild(card);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = '<p style="color:red">상품 목록을 불러오는 데 실패했습니다.</p>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadProducts);
</script>
</body>
</html>
